# GitHub Actions CI/CD for SAE Music Lyrics iOS App
name: iOS Build

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show available SDKs
        run: xcodebuild -showsdks

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Install xcpretty
        run: gem install xcpretty

      - name: Build for iOS Simulator
        run: |
          set -o pipefail
          xcodebuild build \
            -project SAEMusicLyrics.xcodeproj \
            -scheme SAEMusicLyrics \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            2>&1 | xcpretty --color

      - name: Build for iOS Device
        run: |
          set -o pipefail
          xcodebuild build \
            -project SAEMusicLyrics.xcodeproj \
            -scheme SAEMusicLyrics \
            -destination 'generic/platform=iOS' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            2>&1 | xcpretty --color

  lint:
    name: SwiftLint
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --reporter github-actions-logging
        continue-on-error: true

  release:
    name: Create IPA and Release
    runs-on: macos-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || (github.ref == 'refs/heads/main' && github.event_name == 'push')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Create ExportOptions.plist
        run: |
          cat > ExportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>development</string>
              <key>compileBitcode</key>
              <false/>
              <key>thinning</key>
              <string>&lt;none&gt;</string>
          </dict>
          </plist>
          EOF

      - name: Archive App
        run: |
          xcodebuild archive \
            -project SAEMusicLyrics.xcodeproj \
            -scheme SAEMusicLyrics \
            -archivePath build/SAEMusicLyrics.xcarchive \
            -destination 'generic/platform=iOS' \
            -configuration Release \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      - name: Create unsigned IPA
        run: |
          mkdir -p build/Payload
          cp -r build/SAEMusicLyrics.xcarchive/Products/Applications/SAEMusicLyrics.app build/Payload/
          cd build
          zip -r SAEMusicLyrics-unsigned.ipa Payload
          rm -rf Payload
          echo "IPA created successfully!"
          ls -la *.ipa

      - name: Get version info
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="build-$(date +%Y%m%d%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SAEMusicLyrics-${{ steps.version.outputs.version }}
          path: build/SAEMusicLyrics-unsigned.ipa
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          name: SAE Music Lyrics ${{ steps.version.outputs.version }}
          body: |
            ## SAE Music Lyrics ${{ steps.version.outputs.version }}
            
            ### üì± Installation
            
            This is an **unsigned IPA**. To install:
            
            1. **AltStore/SideStore**: Use AltStore or SideStore to sideload the IPA
            2. **Sideloadly**: Use Sideloadly on Windows/Mac to sign and install
            3. **TrollStore**: If you have TrollStore, install directly
            
            ### ‚ö†Ô∏è Note
            - Requires iOS 17.0+
            - Requires Apple Music subscription for full functionality
            - MusicKit only works on physical devices
            
            ### üÜï Changes
            - Real-time word-synced lyrics display
            - 60fps smooth lyric scrolling
            - Tap-to-seek functionality
            - Dark mode support
          files: |
            build/SAEMusicLyrics-unsigned.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release for main branch
        if: github.ref == 'refs/heads/main' && github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: SAE Music Lyrics (Development Build)
          body: |
            ## Development Build
            
            **Build:** ${{ steps.version.outputs.version }}
            **Commit:** ${{ github.sha }}
            
            ‚ö†Ô∏è This is an automated development build from the main branch.
            
            ### üì± Installation
            This is an **unsigned IPA**. Use AltStore, Sideloadly, or TrollStore to install.
          files: |
            build/SAEMusicLyrics-unsigned.ipa
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
